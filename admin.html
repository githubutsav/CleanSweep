    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black/60 z-[3000] flex items-center justify-center hidden">
        <form id="edit-profile-form" class="bg-slate-900 rounded-xl shadow-2xl max-w-md w-full p-8 relative flex flex-col gap-4">
            <button type="button" id="close-edit-profile" class="absolute top-3 right-3 text-slate-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-xl font-bold mb-2 text-center">Edit Profile</h2>
            <label class="text-sm">Name
                <input id="profile-name" name="name" type="text" class="w-full mt-1 px-3 py-2 rounded bg-slate-800 text-white border border-slate-700" required />
            </label>
            <label class="text-sm">Phone Number
                <input id="profile-phone" name="phone" type="tel" class="w-full mt-1 px-3 py-2 rounded bg-slate-800 text-white border border-slate-700" required />
            </label>
            <label class="text-sm">Email
                <input id="profile-email" name="email" type="email" class="w-full mt-1 px-3 py-2 rounded bg-slate-800 text-white border border-slate-700" required />
            </label>
            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full mt-2">Save Changes</button>
            <div id="edit-profile-status" class="text-center text-xs mt-2"></div>
        </form>
    </div>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin & Municipal Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
        <!-- Supabase JS library must be loaded before any code that uses it -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
    <script src="supabaseClient.js"></script>
            <script src="admin.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-3 sm:p-6">
    <header class="w-full p-2 sm:p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Admin & Municipal Dashboard</h1>
        <div class="flex items-center gap-4 text-sm relative">
            <div class="relative group">
                <button id="profile-btn" class="ml-2 flex items-center justify-center w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 focus:outline-none border-2 border-slate-500">
                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                </button>
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-slate-800 border border-slate-700 rounded-lg shadow-lg z-50 py-2">
                    <div class="px-4 py-2 text-slate-400 text-xs" id="auth-user-email"></div>
                    <button id="edit-profile-btn" class="w-full text-left px-4 py-2 hover:bg-slate-700 text-white">Edit Profile</button>
                    <button id="logout-btn" class="w-full text-left px-4 py-2 hover:bg-slate-700 text-white">Logout</button>
                </div>
            </div>
        </div>
    </header>
    <main class="w-full max-w-4xl p-2 sm:p-4 flex flex-col gap-6">
        <!-- Dustbin Status Section -->
        <section class="bg-slate-800/60 p-3 sm:p-4 rounded-lg flex flex-col gap-4 mb-4">
            <h2 class="text-lg font-semibold mb-2">Smart Dustbin Status</h2>
            <div id="dustbin-status" class="text-base text-emerald-300">Loading...</div>
        </section>
        <section class="bg-slate-800/60 p-3 sm:p-4 rounded-lg flex flex-col gap-4">
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label for="municipal-filter" class="block text-sm text-slate-300 mb-1">Filter by Municipal Region</label>
                    <select id="municipal-filter" class="bg-slate-700 text-white px-3 py-2 rounded">
                        <option value="__all__">All Regions</option>
                    </select>
                </div>
                <div>
                    <label for="notify-email" class="block text-sm text-slate-300 mb-1">Notification Email</label>
                    <input id="notify-email" type="email" placeholder="name@example.com" class="bg-slate-700 text-white px-3 py-2 rounded" />
                </div>
                <div>
                    <label for="notify-phone" class="block text-sm text-slate-300 mb-1">SMS Phone (+countrycode)</label>
                    <input id="notify-phone" type="tel" placeholder="+91XXXXXXXXXX" class="bg-slate-700 text-white px-3 py-2 rounded" />
                </div>
                <button id="save-notify-btn" class="bg-emerald-600 hover:bg-emerald-700 font-semibold px-4 py-2 rounded">Save Alerts</button>
            </div>
            <p class="text-xs text-slate-400">Email/SMS here are demo only (no backend). Real delivery requires integrating an email (e.g. Resend, SendGrid) or SMS (e.g. Twilio) provider via a Supabase Edge Function or server. Reports persist in Supabase; they remain visible until explicitly marked cleared.</p>
            <div id="notify-status" class="text-xs text-emerald-400"></div>
        </section>
        <section class="px-2 sm:px-4">
            <h2 class="text-xl font-semibold mb-2">Reported Garbage Locations</h2>
            <div id="admin-map" class="w-full h-96 rounded-lg"></div>
        </section>
        <section class="grid gap-4 md:gap-8 md:grid-cols-2 px-2 sm:px-4">
            <div>
                <h2 class="text-xl font-semibold mb-2 flex items-center gap-2">Active Reports <span id="active-count" class="text-xs bg-slate-700 px-2 py-0.5 rounded"></span></h2>
                <ul id="reports-list" class="space-y-4"></ul>
            </div>
            <div>
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-semibold flex items-center gap-2">History <span id="history-count" class="text-xs bg-slate-700 px-2 py-0.5 rounded"></span></h2>
                    <button id="toggle-history-visibility" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded">Hide</button>
                </div>
                <ul id="history-list" class="space-y-4 max-h-[32rem] overflow-y-auto"></ul>
            </div>
        </section>
    </main>
    <!-- Removed duplicate and unused Supabase client scripts -->
    <script>
    // Require login for admin page and make logout button work robustly
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons();
        }
        (async function(){
            const supabase = window.supabaseClient;
            const { data: { session } } = await supabase.auth.getSession();
            if (!session || !session.user) {
                window.location.href = 'login.html';
                return;
            }
            // Set email in dropdown
            const emailSpan = document.getElementById('auth-user-email');
            if (emailSpan && session.user) emailSpan.textContent = session.user.email;

            // Profile dropdown logic
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileDropdown.classList.contains('hidden')) {
                        profileDropdown.classList.add('hidden');
                    }
                });
                profileDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Logout button in dropdown
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                };
            }

            // Edit profile button (placeholder)
            // Edit Profile logic (admin)
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const modal = document.getElementById('edit-profile-modal');
            const closeBtn = document.getElementById('close-edit-profile');
            const form = document.getElementById('edit-profile-form');
            const nameInput = document.getElementById('profile-name');
            const phoneInput = document.getElementById('profile-phone');
            const emailInput = document.getElementById('profile-email');
            const statusProfileDiv = document.getElementById('edit-profile-status');
            let userId = null;
            if (editProfileBtn && modal && closeBtn && form) {
                editProfileBtn.onclick = null;
                editProfileBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!window.supabaseClient) return;
                    const { data: { session } } = await window.supabaseClient.auth.getSession();
                    if (!session || !session.user) return;
                    userId = session.user.id;
                    nameInput.value = '';
                    phoneInput.value = '';
                    emailInput.value = session.user.email;
                    statusProfileDiv.textContent = 'Loading...';
                    modal.classList.remove('hidden');
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();
                    if (data) {
                        nameInput.value = data.name || '';
                        phoneInput.value = data.phone || '';
                        emailInput.value = data.email || session.user.email;
                    }
                    statusProfileDiv.textContent = '';
                });
                closeBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!window.supabaseClient || !userId) return;
                    statusProfileDiv.textContent = 'Saving...';
                    const updates = {
                        id: userId,
                        name: nameInput.value,
                        phone: phoneInput.value,
                        email: emailInput.value
                    };
                    const { error } = await window.supabaseClient
                        .from('profiles')
                        .upsert(updates, { onConflict: ['id'] });
                    if (error) {
                        statusProfileDiv.textContent = 'Failed to save changes.';
                    } else {
                        statusProfileDiv.textContent = 'Profile updated!';
                        setTimeout(() => { modal.classList.add('hidden'); }, 1200);
                    }
                });
            }

            // View Report button
            const viewReportBtn = document.getElementById('view-report-btn');
            if (viewReportBtn) {
                viewReportBtn.onclick = () => {
                    // You can implement a modal or redirect to a report page
                    alert('View Report feature coming soon!');
                };
            }

            // --- Dustbin Status/Alert Logic ---
            const statusDiv = document.getElementById("dustbin-status");
            let lastLevel = null;
            function showPopup(msg) {
                let popup = document.createElement('div');
                popup.textContent = msg;
                popup.className = 'fixed top-8 right-8 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] text-lg font-bold animate-bounce';
                document.body.appendChild(popup);
                setTimeout(()=>popup.remove(), 5000);
            }
            async function loadDustbinStatus() {
                let { data, error } = await supabase
                    .from('dustbin_status')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(1);
                if (data && data.length > 0) {
                    const level = data[0].level;
                    const ts = new Date(data[0].timestamp).toLocaleString();
                    statusDiv.textContent = `Dustbin Level: ${level}% (updated at ${ts})`;
                    if (level >= 80 && lastLevel !== null && lastLevel < 80) {
                        showPopup(`ðŸš¨ Dustbin is ${level}% full!`);
                    }
                    lastLevel = level;
                } else {
                    statusDiv.textContent = 'No data yet.';
                }
            }
            // Poll every 10s
            setInterval(loadDustbinStatus, 10000);
            loadDustbinStatus();
            // Realtime updates
            supabase
                .channel('dustbin-channel')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'dustbin_status' }, payload => {
                    const level = payload.new.level;
                    const ts = new Date(payload.new.timestamp).toLocaleString();
                    statusDiv.textContent = `Dustbin Level: ${level}% (updated at ${ts})`;
                    if (level >= 80) {
                        showPopup(`ðŸš¨ Dustbin is ${level}% full!`);
                    }
                    lastLevel = level;
                })
                .subscribe();
        })();
    });
    </script>
</body>
</html>
